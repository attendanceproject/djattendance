{% extends "base.html" %}
{% load staticfiles %}
{% load bootstrap3 %}
{% bootstrap_messages %}

{% block title %}{{title}}{% endblock %}

{% block scripts %}
{{ block.super }}
<script type="text/javascript">

  // ajax call to database for inline editing
  function editDB(updated, rem_pk, field) {
    var pass = false;

    $.ajax({
      async: false,
      type: "POST",
      url: "{% url 'graduation:rem-report' %}",
      data: {
        change: updated,
        pk: rem_pk,
        f: field
      },
      success: function(response) {
        pass = true;
        new Notification(Notification.SUCCESS, 'Saved').show();
      },
      error: function(jqXHR, textStatus, errorThrown) {
        new Notification(Notification.ERROR, errorThrown).show();
      }
    });

    return pass;
  }


  // set event for inline editing when you double click remembrance text or reference.
  function inlineEdit() {
    $("#graduation").on('dblclick', ".rem-text, .rem-ref", function(){
      var clicked = $(this);
      var orig = $(this).text(); // for comparison
      if (orig == "None") {
        orig = "";
      }
      var input = $('<input>', {
        value: orig,
        type: 'text',
        blur: function() { // clicking outside box when editing is finished
          var passed = false;
          if (this.value != orig) {
            passed = editDB(this.value, clicked.parent().attr("id"), clicked.attr("class")); // id gives remembrance pk; class gives whether it is text or reference; returns whether database successfully updated
          }

          if (passed) {
            clicked.text(this.value);
          } else {
            clicked.text(orig);
          }
        },
        keyup: function(e) { // if pressing enter
          if (e.which === 13) input.blur();
        }
      });

      input.appendTo( clicked.empty() ).focus();
    })
  }


  $(document).ready(function() {
    $("#graduation").DataTable({
      info: false,
      paging: false,
      dom: '<"row"<"col-sm-6"Bl><"col-sm-6"f>>' +
      '<"row"<"col-sm-12"<"table-responsive"tr>>>' +
      '<"row"<"col-sm-5"i><"col-sm-7"p>>',
      buttons: [
      {
        extend: 'print',
        text: 'Print',
        autoPrint: true,
        exportOptions:{
          columns: ':visible'
        },
      },
      {
        extend: 'csvHtml5',
        text: 'CSV',
        exportOptions: {
          columns: ':visible'
        },
      },
      {
        extend: 'pdf',
        text: 'PDF',
        exportOptions:{
          columns: ':visible'
        },
      },
      {
        extend: 'collection',
        buttons: 'columnsVisibility',
        text: 'Show/Hide Columns',
        columns: ':gt(1)',
      },
      ],

    });

    inlineEdit();

  });

</script>
{% endblock %}

{% block content %}
<h1>{{title}}</h1>

<div class="data-table-container">
  <table id="graduation" class="table table-striped table-bordered">
    <thead>
      <tr>
        <th>Firstname</th>
        <th>Lastname</th>
        <th>Remembrance Text</th>
        <th>Remembrance Reference</th>
      </tr>
    </thead>
    <tbody>
      {% for m in data %}
      <tr id="{{m.id}}">
        <td>{{m.trainee.firstname}}</td>
        <td>{{m.trainee.lastname}}</td>
        <td class="rem-text">{{m.remembrance_text}}</td>
        <td class="rem-ref">{{m.remembrance_reference}}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endblock %}