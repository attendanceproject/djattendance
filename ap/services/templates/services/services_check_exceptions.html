{% extends "base.html" %}
{% load staticfiles %}
{% load bootstrap3 %}
{% load common_tags %}


{% block title %}
Check Exceptions
{% endblock %}

{% block references %}
{{ block.super }}
  <style>
    /* style for workers workload page */

    .worker-addon {
      width: 180px;
      text-align: left;
      max-width: 180px;
    }
    .input-group .worker-input {
      width: 50px;
    }

    /* Style for Service Slots edit page */

    .table.no-border>tbody>tr>td {
      border-top: none;
      /*width: 130px;*/
      padding-right: 10px;
      padding: 5px 10px 0px 0px;
      margin: 0px;
    }

    .table.no-border>tbody>tr {
      border: none;
    }

    .table>tbody>tr.no-padding {
      padding: 0px;
    }

    .table>tbody>tr>td.heading {
      width: 90px;
      padding: 6px 13px;
      text-align: right;
    }

    input.integer-input {
      width: 28px;
      padding: 0px 4px;
      border: 1px solid #ccc;
      border-radius: 3px;
    }

    .active-input {
      width: 20px;
    }

    /* assign page */
    .pin-input {
      white-space:nowrap;
    }

    .shrink {
      width: 20px;
      white-space:nowrap;
    }

    .table-assign {
      margin-bottom: 0px;
    }

    .table-assign th {
      border: none;
    }

    .text-brothers {
      color: inherit;
      border-bottom: 1px solid #337ab7;
      border-bottom: 2px solid #cddae6;
    }

    .text-sisters {
      color: inherit;
      border-bottom: 1px solid #a94442;
      border-bottom: 2px solid #e2a7a5;
    }

    .no-show {
      display: none;
    }

    #calendar {
      max-width: 900px;
      margin: 0 auto;
    }

  </style>
{% endblock %}

{% block scripts %}
{{ block.super }}
  <script>
    $(document).ready(function() {
      $(".shorten").shorten();
    });
  </script>
{% endblock %}


{% block content %}

  <h3 class="no-top-margin">
    <a class="btn btn-primary" href="?week_schedule={{prev_week}}"> < </i></a>
    Services Scheduling ({{ cws }})
    <a class="btn btn-primary" href="?week_schedule={{next_week}}"> > </i></a>
  </h3>

  {% for category in categories %}
    <h3>{{ category }}</h3>
    {% for service in category.services.all %}
      <table class="table table-condensed table-assign">
        <thead>
          <tr>
            <th colspan="4">
              <a href="{% url 'admin:services_service_change' service.id %}" target="_blank">
              {% if category.name == "Designated Services" %}
                {{ service.name }}
              {% else %}
                {{ service.weekday|weekday_name }}
              {% endif %}
              </a>
            </th>
            <th>
              <span class="glyphicon glyphicon-pushpin"></span>
            </th>
          </tr>
        </thead>
        <tbody>
          {% for slot in service.serviceslot_set.all %}
            {% if slot.workers_required > 0 %}
              <tr class="{% if slot.workers_count < slot.workers_required %}warning incomplete-assignment{% endif %}">
                <td class="shrink">{{ slot.name }}</td>
                <td class="shrink worker-count">{{ slot.workers_count }}/{{ slot.workers_required }}</td>
                {% for a in slot.assignments.all %}
                  <td>
                    <div class="worker-text" data-workers="{{ a.workers.all|input_workerID_list }}" data-max="{{ slot.workers_required }}">
                    {% for w in a.workers.all|dictsort:"trainee.lastname" %}
                      <span class="{% if w.trainee.gender == 'B' %}text-brothers{% else %}text-sisters{% endif %}">{{ w.trainee.full_name2 }}</span>,
                    {% endfor %}
                    </div>
                    <div class="worker-input no-show">
                      <input data-assignment="{{ a.id }}" data-slot="{{ slot.id }}" data-service="{{ service.id }}" type="text" placeholder="Workers for this service..." class="demo-default worker-select" value="">
                    </div>
                  </td>
                  <td class="shrink">
                    <a href="#" class="edit-workers no-show" title="Edit Workers">
                      <span class="glyphicon glyphicon-pencil text-muted"></span>
                    </a>
                    <a href="#" class="save-workers no-show" title="Edit Workers">
                      <span class="glyphicon glyphicon-ok text-success"></span>
                    </a>
                    <a href="#" class="cancel-workers no-show" title="Edit Workers">
                      <span class="glyphicon glyphicon-remove text-danger"></span>
                    </a>
                  </td>
                  <td class="shrink">
                    <input type="checkbox" class="pin-input" data-id="{{ a.id }}" {% if a.pin %}checked{% endif %}>
                  </td>
                {% endfor %}
              </tr>
            {% endif %}
            {% empty %}
          {% endfor %}
          <!-- This is for unfilled service slots -->
          {% for slot in service.unassigned_slots %}
            {% if slot.workers_required > 0 %}
              <tr class="danger">
                <td class="shrink">{{ slot.name }}</td>
                <td class="shrink worker-count">0/{{ slot.workers_required }}</td>
                <td>
                  <div class="worker-text" data-max="{{ slot.workers_required }}">
                    <i>No Workers Assigned.</i>
                  </div>
                  <div class="worker-input no-show">
                    <input data-slot="{{ slot.id }}" data-service="{{ service.id }}" type="text" placeholder="Workers for this service..." class="demo-default worker-select" value="">
                  </div>
                </td>
                <td class="shrink">
                  <a href="#" class="edit-workers no-show" title="Edit Workers">
                    <span class="glyphicon glyphicon-pencil text-muted"></span>
                  </a>
                  <a href="#" class="save-workers no-show" title="Edit Workers">
                    <span class="glyphicon glyphicon-ok text-success"></span>
                  </a>
                  <a href="#" class="cancel-workers no-show" title="Edit Workers">
                    <span class="glyphicon glyphicon-remove text-danger"></span>
                  </a>
                </td>
                <td class="shrink">
                  <input type="checkbox" class="pin-input" data-id="">
                </td>
              </tr>
            {% endif %}
          {% endfor %}
        </tbody>
      </table>
    {% endfor %}
  {% endfor %}
    <hr />

<script>
  var worker_update_url = "/api/update-workers/";
  var slots_update_url = "/api/update-workloads/";
  var services_update_url = "/api/update-active-services/";
  var services_update_time_url = "/api/update-time-services/";
  var assignment_workers_url = "/api/service-assignments/";
  var assignment_pin_url = "/api/service-assignments-pin/";
  var exception_active_url = "/api/update-exception-active/";
  var services_admin_url = "{% url 'admin:services_service_changelist' %}";

  var week_schedule_id = {{ cws.id }};

  function sendBulkAjax(url, data) {
    $.ajax({
      contentType: 'application/json',
      dataType: 'json',
      type: 'PATCH',
      url: url,
      data: JSON.stringify(data),
      success: function(response) {
        console.log(response);
        new Notification(Notification.SUCCESS, 'Saved').show();
      }
    })
  }

  var workers = {{ workers_bb|safe }};

  var workers_id_tb = {};

  for (var i=0; i<workers.length; i++) {
    var key = workers[i].id.toString();
    var val = workers[i].full_name;
    workers_id_tb[key] = val;
  }

  $(document).ready(function() {
    $('.manual-mode').click(function(e) {
      var show = window.confirm('Are you sure you want to turn on Manual-Mode? Validation will be turned off and you will be allowed to make illegal assignments');

      if (show) {
        $('.edit-workers').toggle();
      }
    });

    $('.fake-tab-link').click(function(e) {
      var elem = $(this);
      var href = elem.attr('href');
      $('a[href="' + href + '"]').tab('show');

      return false;
    });

    function intializeSelectize(elem$, max) {
      var new_workers = $.extend(true, [], workers);
      console.log('workers', workers, new_workers)
      return elem$.selectize({
        delimiter: ',',
        plugins: ['remove_button'],
        // maxItems: max,
        valueField: 'id',
        labelField: 'full_name',
        searchField: 'full_name',
        options: workers,
        create: false,
        onBlur: function() {
          // saveDB();
        },
      });
    }

    function toggleEditWorkers(elem, destroyInput) {
      var tr = elem.parent().parent();

      tr.find('.worker-text').toggle();
      tr.find('.worker-input').toggle();

      elem.parent().find('.edit-workers').toggle();
      elem.parent().find('.save-workers').toggle();
      elem.parent().find('.cancel-workers').toggle();
    }

    function convertIDsToWorkers(IDList) {
      var workers = [];
      for (var i=0; i<IDList.length; i++) {
        workers.push(workers_id_tb[IDList[i]]);
      }

      return workers;
    }

    $('.save-workers').click(function(e) {
      e.stopPropagation();
      var elem = $(this);

      var tr = elem.parent().parent();
      var textDiv = tr.find('.worker-text');
      var input = tr.find('.worker-select');
      var assignment = input.data('assignment');

      var ajax_type = assignment ? 'PATCH' : 'POST';

      var input_val = input.val().toString();

      console.log('input_val', input_val, assignment, input, textDiv);

      var workers = JSON.parse('[' + input_val + ']');

      var worker_count = workers.length;
      var max = textDiv.data('max');

      var row_class = '';

      if (worker_count == 0) {
        // none
        row_class = 'danger';
      } else if (worker_count < max) {
        // partially filled
        row_class = 'warning';
      } else if (worker_count == max) {
        // full
        row_class = '';
      }

      var data = {
        workers: workers,
        service_slot: input.data('slot'),
        service: input.data('service'),
        week_schedule: week_schedule_id
      };

      if (assignment) {
        data['id'] = assignment;
      }

      console.log('ajaxing out', data, ajax_type);

      $.ajax({
        contentType: 'application/json',
        dataType: 'json',
        type: ajax_type,
        url: assignment_workers_url,
        data: JSON.stringify([data]),
        success: function(response) {

          if (!assignment) {
            var id = response[0].id;
            input.data('assignment', id);
            tr.find('.pin-input').data('id', id);
          }

          console.log(response);

          tr.attr('class', row_class);

          console.log('worker count', worker_count, max);

          // update worker count
          tr.find('.worker-count').html(worker_count + '/' + max);

          var nworkers = convertIDsToWorkers(input_val.split(','));
          var text = nworkers.join(', ');
          text = text == '' ? '<i>No Workers Assigned</i>' : text;

          textDiv.html(text);
          textDiv.data('workers', input_val);

          console.log('saving data', input_val);

          toggleEditWorkers(elem, true);

          new Notification(Notification.SUCCESS, 'Saved').show();
        }
      })


      return false;

    });

    $('.cancel-workers').click(function(e) {
      e.stopPropagation();
      var elem = $(this);
      toggleEditWorkers(elem, true);

      return false;
    });


    $('.edit-workers').click(function(e) {
      e.stopPropagation();

      var elem = $(this);
      var tr = elem.parent().parent();
      var textDiv = tr.find('.worker-text');

      toggleEditWorkers(elem);

      var input = tr.find('.worker-select');
      console.log('elem', input);
      var initValues = textDiv.data('workers') ? textDiv.data('workers').toString() : '';
      var max = textDiv.data('max');
      if (!input.hasClass('selectize-control')) {
        if (initValues && initValues != '') {
          input.attr('value', initValues);
          input.val(initValues);
        }
        console.log('setting input to', initValues, input.val());
        console.log(input.attr('value'));
        var selectized = intializeSelectize(input, max);
        console.log(input.attr('value'));
        input.data('selectize', selectized)
        $(input.next()[0]).find('input').click();
      } else {
        // update object
        var obj = input.data('selectize')[0].selectize;
        obj.clear();
        if (initValues && initValues != '') {
          var initValues = initValues.split(',');
          obj.setValue(initValues);
        }
        console.log('finisehe');
      }

      return false;
    });

    $('.pin-input').click(function(e) {
      var data = [];
      var inputgroups = $('.pin-input');
      var id, ig, val
      for (var i = 0; i < inputgroups.length; i++) {
        val = inputgroups[i].checked;
        ig = $(inputgroups[i]);
        id = ig.data('id');
        if (!id || id == '') {
          continue;
        }
        data.push({
          id: id,
          pin: val,
        });
      }
      sendBulkAjax(assignment_pin_url, data);
    });

    $('.exception-active-input').click((e) => {
      let data = {
        id: $(e.currentTarget).data('id'),
        active: e.currentTarget.checked,
      };
      sendBulkAjax(exception_active_url, [data]);
    });

    /////////////////// Workers Cap + Health ///////////////////

    $('#save-workers').click(function(e) {
      var data = [];
      var inputgroups = $('.worker-group');
      var id, ig, cap, health;
      for (var i = 0; i < inputgroups.length; i++) {
        ig = $(inputgroups[i]);
        id = ig.data('id');

        cap = parseInt(ig.find('.cap-input').val());
        health = parseInt(ig.find('.health-input').val());

        data.push({
          id: id,
          services_cap: cap,
          health: health
        });
      }

      sendBulkAjax(worker_update_url, data);

      return false;
    });


    /////////////////// Service Workloads ///////////////////

    $('.save-workloads').click(function(e) {
      var data = [];
      var inputgroups = $('.serviceslot-input');

      var id, ig, val
      for (var i = 0; i < inputgroups.length; i++) {
        ig = $(inputgroups[i]);
        id = ig.data('id');
        val = parseInt(ig.val());

        data.push({
          id: id,
          workers_required: val
        });
      }

      sendBulkAjax(slots_update_url, data);

      data = [];

      var checkboxgroups = $('.service-active-input');
      var id, ig, val
      for (var i = 0; i < checkboxgroups.length; i++) {
        val = checkboxgroups[i].checked;
        ig = $(checkboxgroups[i]);
        id = ig.data('id');

        console.log('val', val, id);

        data.push({
          id: id,
          active: val
        });
      }

      sendBulkAjax(services_update_url, data);

      return false;
    });

    function incrementCap(increase) {
      var inputs = $('.cap-input');
      var elem, val, new_val;
      for (var i = 0 ; i < inputs.length; i++) {
        elem = $(inputs[i]);
        val = parseInt(elem.val());
        new_val = increase ? val + 1 : val - 1;
        $(elem).attr('value', new_val);
      }
    }

    $('.plus').click(function(e) {
      incrementCap(true);
      return false;
    });

    $('.minus').click(function(e) {
      incrementCap(false);
      return false;
    });

    var options = [];

    const NUM_FILTERS = {{ service_checks|length }};
    let showAll = (dt) => {
      for (var i = dt.columns().nodes().length - NUM_FILTERS - 1; i < dt.columns().nodes().length; i++) {
        dt.columns(i).search('', true, false).draw();
      }
    }
    let filterer = (id) => {
      return function(e, dt, node, config) {
        showAll(dt);
        dt.columns(id).search('True', true, false).draw();
      }
    }
    function initializeDataTable(elem) {
      var dtButtons = [
            {
              extend: 'colvis',
              text: 'Show/Hide Columns',
              columns: ':gt(0)',
            },
            {
              text: 'Show all trainees',
              action: function(e, dt, node, config) {
                showAll(dt);
              }
            }
          ];

      var reviewButtons = [
            {
              text: 'Brothers',
              action: function(e, dt, node, config) {
                showAll(dt);
                dt.columns("#gender").search('B', true, false).draw();
              }
            },
            {
              text: 'Sisters',
              action: function(e, dt, node, config) {
                showAll(dt);
                dt.columns("#gender").search('S', true, false).draw();
              }
            },
            {
              extend: 'csvHtml5',
              text: 'CSV',
              filename: 'Service Schedule Report',
              title: 'Service Schedule Report',
              exportOptions: {
                columns: ':visible'
              },
            },
            {% for check in service_checks %}
            {% verbatim %}{{% endverbatim %}
              text: "{{ check.name|safe }}",
              action: filterer("#{{check.html_id}}"),
            {% verbatim %}},{% endverbatim %}
            {% endfor %}
          ];

      if (elem.attr('id') == 'results') {
        dtButtons = dtButtons.concat(reviewButtons);
      }

      elem.DataTable({
        paging: false,
        columnDefs: [
          {
            targets: 'service-limits',
            visible: false,
          },
          {
            targets: 'gender',
            visible: false,
          },
          {
            targets: 'no-sort',
            orderable: false,
          },
          {
            targets: options, visible: true
          },
          {
            targets: 'category-info',
            visible: true
          },
          {
            targets: '_all',
            visible: true
          },
        ],
        scrollY: '100%',
        scrollCollapse: true,
        scrollX: true,
        dom: '<"row"<"col-sm-8"Bl><"col-sm-4"f>>' +
          '<"row"<"col-sm-12"<"table-responsive"tr>>>' +
          '<"row"<"col-sm-5"i><"col-sm-7"p>>',
        buttons: {
          buttons: dtButtons,
          dom: {
            container: {
              className: 'dt-buttons'
            },
            button: {
              className: 'btn btn-default'
            }
          }
        }
      });
    }

    /////////////////// Reports ///////////////////
    initializeDataTable($('#results'));
    initializeDataTable($('#table_exceptions'));

    $("#save_encouragement").click(function() {
      var encour = $("#encouragement").val();
      $.ajax({
        type: "POST",
        url: "{% url 'services:services_schedule' %}?week_schedule={{current_week}}",
        data: {
          encouragement: encour
        },
        success: function(response) {
          new Notification(Notification.SUCCESS, 'Saved').show();
        },
      });
    });
  })
</script>

<script>
  var services = {{ services_bb|safe }};

  var color_list = [];
  var base_color = xolor('darkslateblue');
  var NUM_OF_COLORS = {{categories.count}};

  for (var i=0; i<NUM_OF_COLORS+1; i++) {
    var color = base_color.gradient('yellowgreen', i / NUM_OF_COLORS).hex;
    color_list.push(color);
  }
  var color_dict = {};
  for (var i=0; i<services.length; i++) {
    var c = services[i].category
    if (!(c in color_dict)) {
      color_dict[c] = color_list.pop();
    }
    services[i]['color'] = color_dict[c];
  }
    var event_tab;


  $(document).ready(function() {

   $('.quantity-right-plus').click(function(e){

        // Stop acting like a button
        e.preventDefault();

        // Get the field name
        var numfield = "#" + $(this).closest("div").css("class", "input-group").children("input").attr('id');
        var quantity = parseInt($(numfield).val());

        // If is not undefined
            $(numfield).val(quantity + 1);
    });

    $('.quantity-left-minus').click(function(e){
        // Stop acting like a button
        e.preventDefault();

        // Get the field name
        var numfield = "#" + $(this).closest("div").css("class", "input-group").children("input").attr('id');
        var quantity = parseInt($(numfield).val());

        if(quantity>0){
          $(numfield).val(quantity - 1);
        }
    });

    var today = moment();
    $('#calendar').fullCalendar({
      header: {
        left: 'prev,next today',
        center: 'title',
        right: 'month,agendaWeek,agendaDay'
      },
      firstDay: 2,  // Set first day to Tuesday
      defaultDate: today,
      defaultView: 'agendaWeek',
      editable: true,
      droppable: true, // this allows things to be dropped onto the calendar
      eventLimit: true, // allow "more" link when too many events
      selectable: true,
      selectHelper: true,
      eventClick: function(event, jsEvent, view){
        if(!event_tab || event_tab.closed){
          event_tab = window.open(services_admin_url+event.id, "_blank");
        } else {
          event_tab.location = services_admin_url+event.id;
          event_tab.focus();
        }
      },
      select: function(start, end) {
        var title = prompt("Enter Service Name");
        var obj = {
          name: title,
          start: start.format('HH:mm:ss'),
          end: end.format('HH:mm:ss'),
          weekday: (start.format('E')-1)
        };
        var str = "";
        for (var key in obj) {
            if (str != "") {
                str += "&";
            }
            str += key + "=" + encodeURIComponent(obj[key]);
        }
        // console.log(services_admin_url+"add/?"+str);
        window.open(services_admin_url+"add/?"+str, "_blank");
      },
      eventResize: updateServiceTimeSlot,
      eventDrop: updateServiceTimeSlot,
      eventSources: [
      {
        events: services
      }]
    });

    function updateServiceTimeSlot(event, delta, revertFunc){
      // console.log(event, delta, revertFunc, services_update_time_url);
      data = [];
      data.push({
        id: event.id,
        name: event.title,
        start: event.start.format('h:mm:ss a'),
        end: event.end.format('h:mm:ss a'),
        weekday: (event.start.format('E')-1)
      });
      // console.log(data);
      sendBulkAjax(services_update_time_url, data);
    }

    $('a[data-toggle="tab"][href="#servicescalendar"]').on('shown.bs.tab', function(e){
      $('#calendar').fullCalendar('today');
    })
  });

</script>
<style>
  #calendar {
    max-width: 900px;
    margin: 0 auto;
  }
</style>

<link rel="stylesheet" type="text/css" href="{% static 'services/css/vertical-tabs.css' %}">

{% endblock %}
