{% extends "requests/request_tabs.html" %}
{% load staticfiles %}
{% load bootstrap3 %}
{% load common_tags %}
{% bootstrap_messages %}

{% block title %}{{ view.model|model_verbose_name|title }} Form{% endblock %}

{% block references %}
{{ block.super }}
<style type="text/css">
  label[for=id_house] {
    grid-column: 1 / 2;
    grid-row: 2 / 3;
  }

  #id_house {
    grid-column: 1 / 2;
    grid-row: 3 / 4;
  }

  label[for=id_description] {
    grid-column: 3 / 4;
    grid-row: 2 / 3;
  }

  #id_description {
    grid-column: 3 / 4;
    grid-row: 3 / 10;
  }

  label[for=id_room] {
    grid-column: 1 / 2;
    grid-row: 5 / 6;
  }

  #id_room {
    grid-column: 1 / 2;
    grid-row: 6 / 7;
  }

  label[for=id_request_type] {
    grid-column: 1 / 2;
    grid-row: 8 / 9;
  }

  #id_request_type {
    grid-column: 1 / 2;
    grid-row: 9 / 10;
  }

  td {
    text-align: left;
  }

  .center-col {
    text-align: center;
  }

  .datatable-buttons {
    /*position: absolute;*/
    /*top: 50px;*/
  }
</style>
{% endblock %}

{% block scripts %}
  {{ block.super }}
  {{ form.media }}
  <script>
    var rooms = {{ rooms|safe }};
    $(document).ready(() => {

      let room_elem = $('#id_room');
      room_elem.empty();
      $("#id_house").on("change", e => {
        room_elem.empty();
        let house_id = parseInt(e.target.value);
        let new_room_options = rooms.filter(r => r.fields.house == house_id);
        new_room_options.forEach(o => {
          let option = $('<option></option>').attr('value', o.pk)
            .text($("#id_house :selected").text() + ' ' + o.fields.type);
          room_elem.append(option);
        });
        if (['MCC', 'TC'].includes($(e.currentTarget).find('option:selected').text())) {
          room_elem.attr("disabled", true);
        } else {
          room_elem.attr("disabled", false);
        }
      });
      $('#id_description').removeAttr("style");

      $("#id_request_table").DataTable({
        info: false,
        paging: true,
        autoWidth: true,
        order: [[ 7, "desc" ]],
        lengthMenu: [[25, 50, 100, 200, -1], [25, 50, 100, 200, "All"]],
        dom: '<"datatable-buttons row"<"col-sm-6"Bl><"col-sm-6"f>>' +
        '<"row"<"col-sm-12"<"table-responsive"tr>>>' +
        '<"row"<"col-sm-5"i><"col-sm-7"p>>',
        columnDefs: [
          {
            "targets": 0,
            "searchable": false,
          }
        ]
      });
    });
  </script>
{% endblock %}

{% block request_form %}
  <div class="grid">
    {{ form.house.label_tag }}
    {{ form.house }}

    {{ form.room.label_tag }}
    {{ form.room }}

    {{ form.request_type.label_tag }}
    {{ form.request_type }}

    {{ form.description.label_tag }}
    {{ form.description }}
  </div>

  {{ form.urgent }} Urgent
{% endblock %}

{% block trainee_request_table %}
  <div class="data-table-container">
    <table id="id_request_table" class="table table-striped table-bordered">
      <thead>
        <tr>
          <th>Urgent</th>
          <th>Date</th>
          <th>Location</th>
          <th>Name</th>
          <th>Phone</th>
          <th>Type</th>
          <th>Description</th>
          <th>Status</th>
          <th>Comments</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for request in object_list %}
          <tr>
            <td class="center-col">
              {% if request.urgent %}*{% endif %}
            </td>
            <td>{{request.date_requested|date:"m/d/y"}}</td>
            <td>
              {% if request.room %}
                {{request.room}}
              {% else %}
                {{request.house}}
              {% endif %}
            </td>
            <td>{{request.trainee_author.full_name}}</td>
            <td>{{request.trainee_author.meta.phone}}</td>
            <td class="center-col">{{request.request_type}}</td>
            <td>{{request.description}}</td>
            <td class="center-col">
              {% if request.status == "P" %}
                Pending
              {% elif request.status == "C" %}
                Approved
              {% else %}
                Marked for Fellowship
              {% endif %}
            </td>
            <td>{{request.TA_comments}}</td>
            <td></td> <!-- TODO add action buttons -->
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
{% endblock %}

{% block ta_tabs %}
    <ul class="nav nav-tabs" role="tablist">
      <li role="presentation" class="active"><a href="#ta-urgent" aria-controls="profile" role="tab" data-toggle="tab">Urgent</a></li>
      <li role="presentation"><a href="#ta-nonurgent" aria-controls="home" role="tab" data-toggle="tab">Non-Urgent</a></li>
      <li role="presentation"><a href="#request-tab" aria-controls="home" role="tab" data-toggle="tab">Create New</a></li> <!-- tab defined above -->
    </ul>
{% endblock %}

{% block ta_tab_contents %}
    <div id="ta-urgent" class="tab-pane" role="tabpanel">
    </div>

    <div id="ta-nonurgent" class="tab-pane" role="tabpanel">
    </div>
{% endblock %}


{% block extra_form_elements %}
  <div class="alert alert-warning">
    <p>Please note that routine maintenance requests are usually serviced on Saturdays.</p>
    <p>
      For an emergency, please call:
      <ul>
        <li>John Blatz (714) 493-0037</li>
        <li>Solomon Leung (714) 863-5082</li>
        <li>Vu Tran (714) 270-3064</li>
      </ul>
    </p>
  </div>
{% endblock %}
