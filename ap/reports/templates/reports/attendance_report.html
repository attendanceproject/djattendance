{% extends "base.html" %}
{% load staticfiles %}
{% load bootstrap3 %}

{% block title %} Attendance Report {% endblock %}

{% block scripts %}
<script type="text/javascript">

var attendance_records = [];
var date_from = "{{date_from}}";
var date_to = "{{date_to}}";
var trainee_ids = {{trainee_ids}};

// define headers and computed values to calculate averages
var average_headers = ['unexcused_absences_percentage', 'sickness_percentage', 'tardy_percentage', 'classes_missed_percentage'];
var average_values = []
for (var i =0; i<average_headers.length; i++){
  average_values.push(0)
}

// dynamically adjust the progress bar as ajax requets are being completed
function update_progress(){
  var compute_percentage = Math.round(attendance_records.length / trainee_ids.length * 100)
  $("#progressbar").children().attr("aria-valuenow", compute_percentage).css("width", compute_percentage + "%").text(compute_percentage + "% Complete");
}

// making a a single row record of HTML to append first for localities by listing only the serving teams
function append_response(trainee_info){
  var trainee_record = document.createElement("tr");
  var column_headers = ["name", "ta", "term", "team", "gender", "unexcused_absences_percentage", "tardy_percentage", "sickness_percentage", "classes_missed_percentage"]

  for (var i = 0; i< column_headers.length; i++){
    var col = document.createElement("td");
    col.innerHTML = trainee_info[column_headers[i]]
    trainee_record.append(col)
  }

  table_id = "locality-" + trainee_info["sending_locality"]
  $("#"+table_id).children("tbody").append(trainee_record)

  append_team(trainee_record.cloneNode(true), trainee_info)

}

// adjust the record made for localities and adjust it for teams by changing the serving teams to sending localities
function append_team(constructed_row, trainee_info){
  l_id = trainee_info["sending_locality"]
  locality = $("#locality-"+l_id).prev().children().first().text()
  col = constructed_row.children.item(3)
  col.innerHTML = locality

  table_id = "team-" + trainee_info["team"]
  $("#"+table_id).children("tbody").append(constructed_row)

}

function send_averages(){
}

// single ajax request for a single trainee based upon trainee id
// using this to do parallel processing for trainee information by utilizing client-server infrastructure
function get_trainee_record(trainee_id){
	$.ajax({
      type: "GET",
      url: "{% url 'reports:attendance-report-individual-trainee' %}",
      data: {
      	t_id: trainee_id,
      },
      success: function(response){
          attendance_records.push(response)
          append_response(response)
          update_progress()

          // used for computing the averages by first obtaining the sum for each one
          for (var i = 0; i < average_headers.length; i++) {
            average_values[i] = average_values[i] + parseFloat(response[average_headers[i]])
          };

          // once all the ajax requests are completed, compute the averages and render it
          // also show the content of the now completed attendance report
          if (attendance_records.length == trainee_ids.length){
            var list = document.createElement("ul")

            for (var i = 0; i < average_headers.length; i++) {
              var item = document.createElement("li")
              avg_value = (Math.round((average_values[i] / attendance_records.length) * 100) / 100).toFixed(2) + "%"
              item.innerHTML = average_headers[i] + ": " + avg_value
              list.append(item)

            };

            $("#averages").append(list)
            send_averages()

            console.log("complete")
            $("#navigation_bar").show()
            $(".tab-content").show()
            $(".progress-bar").removeClass("active")
          }
        },
      })
};



$( document ).ready(() => {
	trainee_ids.forEach(function(element) {
		get_trainee_record(element);
	});
  $("#navigation_bar").hide()
  $(".tab-content").hide()
  $( "body" ).on('click', '#zip_download_link', function(){
    window.open("{% url 'reports:zip-attendance-report' %}", '_blank')
  })
})



</script>
{% endblock %}

{% block references %}
<style type="text/css">

</style>
{% endblock %}

{% block content %}

<div id="progressbar" class="progress">
  <div class="progress-bar progress-bar-striped active" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="min-width: 2em;">0%
  </div>
</div>

<div id="averages">
</div>


<ul id="navigation_bar" class="nav nav-tabs" role="tablist">
  <li role="presentation" class="active"><a href="#sending_locality" role="tab" data-toggle="tab">By Locality</a></li>
  <li role="presentation"><a href="#serving_team" role="tab" data-toggle="tab">By Team</a></li>
  <li role="presentation"><a id="zip_download_link" href="#zip_download" role="tab" data-toggle="tab">Download Zip File</a></li>
</ul>

<div class="tab-content">
  <div id="sending_locality" class="tab-pane active" role="tabpanel" >

    {% for locality in localities %}
    <div class="panel-body">
      <h2><span class="locality-name">{{ locality.name }}</span> Sending Locality Generated Report from {{date_from}} to {{date_to}} </h2>
      <table id="locality-{{locality.id}}" class="table table-striped">
        <thead><tr>
          <th>Trainee</th>
          <th>TA</th>
          <th>Term</th>
          <th>Team</th>
          <th>Gender</th>
          <th>% Unex. Abs.</th>
          <th>% Tardy</th>
          <th>% Sickness</th>
          <th>% Classess Missed</th>

        </tr></thead>
        <tbody></tbody>
      </table>
    </div>
    {% endfor %}

  </div>

  <div id="serving_team" class="tab-pane active" role="tabpanel" >
    {% for team in teams %}
    <div class="panel-body">
      <table id="team-{{team}}" class="table table-striped">
        <h2> {{ team }} Team Generated Report from {{date_from}} to {{date_to}} </h2>
        <thead><tr>
          <th>Trainee</th>
          <th>TA</th>
          <th>Term</th>
          <th>Sending Locality</th>
          <th>Gender</th>
          <th>% Unex. Abs.</th>
          <th>% Tardy</th>
          <th>% Sickness</th>
          <th>% Classess Missed</th>

        </tr></thead>
        <tbody></tbody>
      </table>
    </div>
    {% endfor %}
  </div>

  <div id="zip_download" class="tab-pane active" role="tabpanel" >
  </div>
  {% endblock %}


